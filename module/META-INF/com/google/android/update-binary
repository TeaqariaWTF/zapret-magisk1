#!/sbin/sh

#################
# Initialization
#################

umask 022

# echo before loading util_functions
ui_print() { echo "$1"; }

require_new_magisk() {
  ui_print "*******************************"
  ui_print " Please install Magisk v20.4+! "
  ui_print "*******************************"
  exit 1
}

#########################
# Load util_functions.sh
#########################

OUTFD=$2
ZIPFILE=$3

MODID=zapret
MODPATH=/data/adb/modules/$MODID
MODUPDATEPATH=/data/adb/modules_update/$MODID

mount /data 2>/dev/null

ui_print "- You're installing module from ZIP file"

abort() {
  rmdir "$MODUPDATEPATH"
  rmdir "$MODPATH"
  exit 1
}

grep_prop() {
  local REGEX="s/^$1=//p"
  shift
  local FILES=$@
  [ -z "$FILES" ] && FILES='/system/build.prop'
  cat $FILES 2>/dev/null | dos2unix | sed -n "$REGEX" | head -n 1
}

print_title() {
  local len line1len line2len bar
  line1len=$(echo -n $1 | wc -c)
  line2len=$(echo -n $2 | wc -c)
  len=$line2len
  [ $line1len -gt $line2len ] && len=$line1len
  len=$((len + 2))
  bar=$(printf "%${len}s" | tr ' ' '*')
  ui_print "$bar"
  ui_print " $1 "
  [ "$2" ] && ui_print " $2 "
  ui_print "$bar"
}

extract_module_files() {
  ui_print "- Extracting module files"
  unzip -o "$ZIPFILE" -x 'META-INF/*' -d $MODPATH >&2
}

extract_module_files
rmdir "$MODUPDATEPATH"
MODNAME=$(grep_prop name $MODPATH/module.prop)
MODAUTH=$(grep_prop author $MODPATH/module.prop)
print_title "$MODNAME" "by $MODAUTH"

ui_print "- Fixing scripts syntax"
for FILE in "$MODPATH"/*.sh; do
  if [ -f "$FILE" ]; then
    sed -i 's/\r$//' "$FILE"
  fi
done

. $MODPATH/sevcator.sh

exit 0
